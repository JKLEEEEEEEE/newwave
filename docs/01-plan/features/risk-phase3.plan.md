# Risk Monitoring System - Phase 3 계획서

> **기능명**: risk-phase3
> **버전**: v2.3
> **작성일**: 2026-02-05
> **기반**: risk-improvements Phase 2 완료 (Match Rate 92%)

---

## 1. 개요

### 1.1 목적

Phase 2 (실제 데이터 연동) 완료 후, 고급 분석 기능을 구현하여 리스크 모니터링 시스템의 분석 능력을 고도화합니다.

### 1.2 현재 상태

| 항목 | 상태 | 비고 |
|------|------|------|
| Neo4j 연동 | ✅ 완료 | neo4j_client.py |
| OpenAI 연동 | ✅ 완료 | ai_service_v2.py (6대 기능) |
| WebSocket | ✅ 완료 | signal_publisher.py |
| 시뮬레이션 | ⚠️ 기본 | 카테고리별 고정 증가분 적용 |
| ML 예측 | ❌ 미구현 | 설계만 존재 |
| 커스텀 시나리오 | ❌ 미구현 | 프리셋만 존재 |

### 1.3 목표

| 목표 | 설명 | 측정 기준 |
|------|------|----------|
| 시뮬레이션 정교화 | 공급망 기반 동적 Cascade 계산 | 실제 사례 대비 80% 정확도 |
| ML 리스크 예측 | 시계열 기반 리스크 예측 | MAPE 20% 이하 |
| 커스텀 시나리오 | 사용자 정의 시나리오 생성 | UI 완성도 |

---

## 2. 구현 범위

### 2.1 P0: 시뮬레이션 로직 정교화

**현재 문제**:
- 카테고리별 고정 증가분 적용 (예: supply_chain +20점)
- 공급망 관계 무시
- Cascade 효과 미반영

**목표 기능**:
```
┌─────────────────────────────────────────────────────────────┐
│ 시나리오: "부산항 파업"                                      │
├─────────────────────────────────────────────────────────────┤
│ 1. Neo4j에서 영향받는 기업 추출                              │
│    MATCH (c:Company)-[:SUPPLIES_TO*1..3]->(affected)        │
│    WHERE c.sector IN ['물류', '반도체']                      │
│                                                              │
│ 2. Cascade 효과 계산                                         │
│    - 1차 영향: 직접 공급사 → score * 0.8                     │
│    - 2차 영향: 2차 공급사 → score * 0.5                      │
│    - 3차 영향: 3차 공급사 → score * 0.2                      │
│                                                              │
│ 3. 결과 시각화                                               │
│    - 영향받는 기업 목록 + 예상 점수 변화                      │
│    - 그래프 하이라이트                                       │
└─────────────────────────────────────────────────────────────┘
```

**구현 항목**:
- [ ] `risk_engine/simulation_engine.py` - 시뮬레이션 엔진
- [ ] Neo4j Cascade 쿼리 최적화
- [ ] 시나리오별 전이 배수 동적 조정
- [ ] 결과 캐싱 (Redis 또는 메모리)

### 2.2 P1: ML 기반 리스크 예측

**목표**:
- 과거 리스크 데이터 기반 미래 예측
- 시계열 분석 (Prophet, LSTM)
- 이상 탐지 (Anomaly Detection)

**아키텍처**:
```
┌─────────────────────────────────────────────────────────────┐
│ 데이터 파이프라인                                            │
├─────────────────────────────────────────────────────────────┤
│ Neo4j (과거 데이터)                                          │
│     ↓                                                        │
│ Feature Engineering                                          │
│   - 일별 리스크 점수                                         │
│   - 뉴스 감성 지표                                           │
│   - 공시 빈도                                                │
│   - 시장 지표 (KOSPI, 환율)                                  │
│     ↓                                                        │
│ Model Training                                               │
│   - Prophet (트렌드 + 계절성)                                │
│   - LSTM (복잡한 패턴)                                       │
│     ↓                                                        │
│ Prediction API                                               │
│   - 7일/30일/90일 예측                                       │
│   - 신뢰 구간 제공                                           │
└─────────────────────────────────────────────────────────────┘
```

**구현 항목**:
- [ ] `risk_engine/ml_predictor.py` - ML 예측 모듈
- [ ] `scripts/train_model.py` - 모델 학습 스크립트
- [ ] `risk_engine/feature_engineering.py` - 피처 추출
- [ ] API 엔드포인트: `/api/v2/predict/{deal_id}`
- [ ] Frontend 예측 차트 컴포넌트

### 2.3 P1: 커스텀 시나리오 UI

**현재 상태**:
- 프리셋 시나리오만 존재 (부산항 파업, 반도체 수요 급감 등)
- 사용자 정의 불가

**목표 기능**:
```
┌─────────────────────────────────────────────────────────────┐
│ 🎯 커스텀 시나리오 생성                                      │
├─────────────────────────────────────────────────────────────┤
│ 시나리오 이름: [________________]                            │
│                                                              │
│ 영향 섹터 선택:                                              │
│ [✓] 반도체  [ ] 자동차  [✓] 물류  [ ] 금융                  │
│                                                              │
│ 카테고리별 영향도:                                           │
│ ├── 공급망:    [====●=====] +15                             │
│ ├── 시장:      [==●=======] +8                              │
│ ├── 법률:      [●=========] +0                              │
│ └── 운영:      [===●======] +12                             │
│                                                              │
│ 전이 배수: [1.2x] [1.5x] [●2.0x]                            │
│                                                              │
│ [시뮬레이션 실행]  [저장]  [취소]                            │
└─────────────────────────────────────────────────────────────┘
```

**구현 항목**:
- [ ] `components/risk/RiskScenarioBuilder.tsx` - 시나리오 빌더 UI
- [ ] `components/risk/RiskSlider.tsx` - 영향도 슬라이더
- [ ] API: `POST /api/v2/scenarios` - 시나리오 저장
- [ ] API: `GET /api/v2/scenarios/custom` - 커스텀 시나리오 목록
- [ ] Neo4j 시나리오 저장 스키마

---

## 3. 기술 스택 추가

### 3.1 ML/AI

| 라이브러리 | 용도 | 버전 |
|-----------|------|------|
| prophet | 시계열 예측 | >= 1.1.0 |
| scikit-learn | 피처 엔지니어링 | >= 1.3.0 |
| tensorflow | LSTM 모델 (선택) | >= 2.15.0 |

### 3.2 캐싱

| 도구 | 용도 |
|------|------|
| Redis | 시뮬레이션 결과 캐싱 |
| functools.lru_cache | 메모리 캐싱 (폴백) |

### 3.3 Frontend

| 라이브러리 | 용도 |
|-----------|------|
| recharts | 예측 차트 |
| @radix-ui/react-slider | 영향도 슬라이더 |

---

## 4. 단계별 로드맵

### Week 1: 시뮬레이션 정교화

| 일차 | 작업 | 담당 |
|------|------|------|
| 1-2일 | simulation_engine.py 설계 및 구현 | Backend |
| 3일 | Neo4j Cascade 쿼리 최적화 | Backend |
| 4일 | RiskSimulation.tsx 업데이트 | Frontend |
| 5일 | 통합 테스트 및 버그 수정 | All |

**산출물**:
- simulation_engine.py
- 업데이트된 RiskSimulation.tsx
- 시뮬레이션 정확도 테스트 결과

### Week 2: ML 리스크 예측

| 일차 | 작업 | 담당 |
|------|------|------|
| 1일 | feature_engineering.py 구현 | Data |
| 2-3일 | ml_predictor.py (Prophet) 구현 | Data |
| 4일 | API 엔드포인트 추가 | Backend |
| 5일 | 예측 차트 컴포넌트 | Frontend |

**산출물**:
- ml_predictor.py
- feature_engineering.py
- RiskPrediction.tsx
- 모델 정확도 리포트

### Week 3: 커스텀 시나리오 + 통합

| 일차 | 작업 | 담당 |
|------|------|------|
| 1-2일 | RiskScenarioBuilder.tsx 구현 | Frontend |
| 3일 | 시나리오 저장 API 구현 | Backend |
| 4일 | 전체 통합 테스트 | All |
| 5일 | 문서화 및 리뷰 | All |

**산출물**:
- RiskScenarioBuilder.tsx
- 커스텀 시나리오 API
- Phase 3 완료 보고서

---

## 5. 성공 기준

### 5.1 시뮬레이션 정교화

| 항목 | 기준 | 측정 방법 |
|------|------|----------|
| Cascade 정확도 | 실제 사례 대비 80% | 백테스트 |
| 응답 시간 | < 3초 (100개 기업) | 성능 테스트 |
| 캐시 적중률 | > 70% | 로그 분석 |

### 5.2 ML 예측

| 항목 | 기준 | 측정 방법 |
|------|------|----------|
| MAPE | < 20% | 검증 데이터셋 |
| 예측 범위 | 7/30/90일 | 기능 테스트 |
| 신뢰 구간 | 95% | 통계 검증 |

### 5.3 커스텀 시나리오

| 항목 | 기준 | 측정 방법 |
|------|------|----------|
| UI 완성도 | 모든 컴포넌트 동작 | 기능 테스트 |
| 저장/로드 | 정상 작동 | E2E 테스트 |
| 사용성 | 직관적 UX | 사용자 피드백 |

---

## 6. 리스크 및 의존성

### 6.1 기술적 리스크

| 리스크 | 영향 | 완화 방안 |
|--------|------|---------|
| Prophet 학습 데이터 부족 | 높음 | 합성 데이터 생성, 전이 학습 |
| Cascade 쿼리 성능 저하 | 중간 | 인덱스 최적화, 쿼리 캐싱 |
| Redis 의존성 | 낮음 | 메모리 캐시 폴백 |

### 6.2 외부 의존성

| 의존성 | 설명 | 대안 |
|--------|------|------|
| Prophet | Meta 시계열 예측 | statsmodels ARIMA |
| Redis | 분산 캐싱 | 메모리 캐시 |
| 학습 데이터 | 과거 리스크 이력 | Mock 데이터 생성 |

---

## 7. 파일 구조 (예상)

```
risk_engine/
├── simulation_engine.py    [신규] 시뮬레이션 엔진
├── ml_predictor.py         [신규] ML 예측 모듈
├── feature_engineering.py  [신규] 피처 추출
├── cache_manager.py        [신규] 캐시 관리
└── api.py                  [수정] 새 엔드포인트

scripts/
├── train_model.py          [신규] 모델 학습
└── generate_training_data.py [신규] 학습 데이터 생성

components/risk/
├── RiskScenarioBuilder.tsx [신규] 시나리오 빌더
├── RiskPrediction.tsx      [신규] 예측 차트
├── RiskSlider.tsx          [신규] 영향도 슬라이더
└── RiskSimulation.tsx      [수정] 시뮬레이션 개선
```

---

## 8. 참고 자료

- **기반 문서**: `docs/archive/2026-02/risk-improvements/` (아카이브됨)
- **기존 코드**: `risk_engine/`, `components/risk/`
- **Neo4j 스키마**: Company, NewsArticle, Disclosure 노드

---

**작성**: 2026-02-05
**상태**: Plan 완료
**다음 단계**: `/pdca design risk-phase3`
